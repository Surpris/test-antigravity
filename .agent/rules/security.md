---
trigger: always_on
---

# セキュリティ上の遵守事項

## エンドポイントへの攻撃に関して

### 1. 基本方針

- **「ブラウザからの入力」を信用しない**: ユーザー（または攻撃者）が操作可能なブラウザからのリクエストパラメータは、容易に改ざん可能であることを前提とする。
- **設計段階でのレビュー**: 実装後の修正コストを下げるため、シーケンス図などを用いて設計段階で脅威（改ざん、迂回、再送など）を洗い出す。

### 2. 具体的な脅威への対策事項

#### ① 改ざん (Tampering) への対策

- **認可制御の徹底 (IDOR 対策)**: URL やパラメータに含まれる ID が書き換えられるリスクを想定し、サーバー側で「リクエスト送信者がそのリソースへのアクセス権を持っているか」を必ず検証する。
- **ステータスの裏取り**: 外部サービスからのコールバック（リダイレクト）に含まれるステータス情報（`status=ok`など）を鵜呑みにせず、**サーバー間通信**で外部サービスへ直接問い合わせて正しいステータスを確認する。または、署名検証を行い改ざんを検知する。

#### ② 迂回 (Detour) への対策

- **プロセス順序の強制**: 「見積もり確認 → 購入」のように本来経由すべき手順がスキップされないよう、前の手順が完了したことを証明するトークン（ワンタイムトークンなど）を検証する仕組みを導入する。
- **エンドポイントの保護**: コールバック用 URL などの公開エンドポイントであっても、認証・認可のチェックを省略しない。

#### ③ 再送 (Replay) への対策

- **冪等性（べきとうせい）の確保**: 同じリクエストが複数回送信された場合でも、二重処理（e-コマースでの例: 二重課金、ポイントの二重付与）が起きないよう設計する。
- ステータス管理（「未処理」の場合のみ実行するなど）を行う。
- リクエストごとに使い捨てのトークン（Nonce）を発行し、検証する。

#### ④ 遅延 (ToCToU: Time-of-Check to Time-of-Use) への対策

- **直前検証の実施**: 「確認（Check）」から「実行（Use）」までのわずかな時間差で状況が変わる（e-コマースでの例: クーポンの有効期限切れ、在庫切れ）リスクを考慮し、処理実行のトランザクション内でもう一度前提条件を検証する。

#### ⑤ 同時実行 (Race Condition) への対策

- **排他制御の実装**: 短時間に複数のリクエストが同時に送信された場合でも整合性を保てるよう、データベースのロック（行ロックなど）やアトミックな更新処理を用い、競合状態を防ぐ。

## そのほか

- XSS 攻撃対策: ユーザー入力の適切なサニタイズ
- CSP（Content Security Policy）の実装
- 機密データの暗号化は不要（ローカル保存のため）
